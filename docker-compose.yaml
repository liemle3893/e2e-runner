services:
  # Azurite - Azure Storage emulator
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.35.0
    ports:
      - "127.0.0.1:10000:10000"  # Blob service
      - "127.0.0.1:10001:10001"  # Queue service
      - "127.0.0.1:10002:10002"  # Table service
    volumes:
      - "azurite-data:/data"
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 -l /data"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - NET_RAW

  # MongoDB for local development (alternative to Cosmos DB)
  mongodb:
    image: mongo:7.0.14
    ports:
      - "127.0.0.1:27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_USERNAME:-root}
    volumes:
      - "mongodb-data:/data/db"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - NET_RAW

  # Event Hubs Emulator - Azure Event Hubs emulator for local testing
  eventhubs-emulator:
    image: mcr.microsoft.com/azure-messaging/eventhubs-emulator:2.1.0
    ports:
      - "127.0.0.1:5672:5672"    # AMQP
      - "127.0.0.1:9092:9092"    # Kafka
      - "127.0.0.1:5300:5300"    # Health check API
    environment:
      ACCEPT_EULA: "Y"
      BLOB_SERVER: "azurite"
      METADATA_SERVER: "azurite"
    depends_on:
      - azurite
    volumes:
      - ./config/eventhubs-emulator.json:/Eventhubs_Emulator/ConfigFiles/Config.json
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - NET_RAW

  # PostgreSQL with Citus extension for Fortune Play
  postgres:
    image: citusdata/citus:13.0
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fortune}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fortune}
      POSTGRES_DB: ${POSTGRES_DB:-fortune_play}
    volumes:
      - "postgres-data:/var/lib/postgresql/data"
      - "./demo-server/init/schema.sql:/docker-entrypoint-initdb.d/schema.sql"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - NET_RAW

  # Redis for rate limiting and credit caching
  redis:
    image: redis:7.4-alpine
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - "redis-data:/data"
    command: redis-server --appendonly yes
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - NET_RAW


volumes:
  mongodb-data: {}
  azurite-data: {}
  postgres-data: {}
  redis-data: {}
